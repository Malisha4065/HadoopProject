version: '3.8'

services:
  namenode:
    image: apache/hadoop:3.4.1
    hostname: namenode
    command: ["hdfs", "namenode"]
    ports:
      - "9870:9870"    # NameNode Web UI
      - "8020:8020"    # NameNode RPC
    environment:
      ENSURE_NAMENODE_DIR: "/tmp/hadoop-root/dfs/name"
    env_file:
      - ./hadoop.env
    volumes:
      - namenode_data:/tmp/hadoop-root/dfs/name
      - ./data:/opt/hadoop/data          # Mount for your datasets
      - ./java-src:/opt/hadoop/java-src  # Mount for Java source files
      - ./jars:/opt/hadoop/jars          # Mount for compiled JARs
      - ./results:/opt/hadoop/results    # Mount for results
    networks:
      - hadoop

  datanode:
    image: apache/hadoop:3.4.1
    hostname: datanode
    command: ["hdfs", "datanode"]
    environment:
      SERVICE_PRECONDITION: "namenode:9870"
    env_file:
      - ./hadoop.env
    volumes:
      - datanode_data:/tmp/hadoop-root/dfs/data
      - ./data:/opt/hadoop/data
      - ./java-src:/opt/hadoop/java-src
      - ./jars:/opt/hadoop/jars
      - ./results:/opt/hadoop/results
    networks:
      - hadoop
    depends_on:
      - namenode

  resourcemanager:
    image: apache/hadoop:3.4.1
    hostname: resourcemanager
    command: ["yarn", "resourcemanager"]
    ports:
      - "8088:8088"    # ResourceManager Web UI
    environment:
      SERVICE_PRECONDITION: "namenode:9870 datanode:9864"
    env_file:
      - ./hadoop.env
    volumes:
      - ./data:/opt/hadoop/data
      - ./java-src:/opt/hadoop/java-src
      - ./jars:/opt/hadoop/jars
      - ./results:/opt/hadoop/results
    networks:
      - hadoop
    depends_on:
      - namenode
      - datanode

  nodemanager:
    image: apache/hadoop:3.4.1
    hostname: nodemanager
    command: ["yarn", "nodemanager"]
    environment:
      SERVICE_PRECONDITION: "namenode:9870 datanode:9864 resourcemanager:8088"
    env_file:
      - ./hadoop.env
    volumes:
      - ./data:/opt/hadoop/data
      - ./java-src:/opt/hadoop/java-src
      - ./jars:/opt/hadoop/jars
      - ./results:/opt/hadoop/results
    networks:
      - hadoop
    depends_on:
      - namenode
      - datanode
      - resourcemanager

  historyserver:
    image: apache/hadoop:3.4.1
    hostname: historyserver
    command: ["yarn", "timelineserver"]
    ports:
      - "8188:8188"    # History Server Web UI
    environment:
      SERVICE_PRECONDITION: "namenode:9870 datanode:9864 resourcemanager:8088"
    env_file:
      - ./hadoop.env
    volumes:
      - ./data:/opt/hadoop/data
      - ./java-src:/opt/hadoop/java-src
      - ./jars:/opt/hadoop/jars
      - ./results:/opt/hadoop/results
    networks:
      - hadoop
    depends_on:
      - namenode
      - datanode
      - resourcemanager

  # Client container for compiling and running Java jobs
  hadoop-client:
    image: apache/hadoop:3.4.1
    hostname: hadoop-client
    command: ["tail", "-f", "/dev/null"]  # Keep container running
    environment:
      SERVICE_PRECONDITION: "namenode:9870 datanode:9864 resourcemanager:8088"
    env_file:
      - ./hadoop.env
    volumes:
      - ./data:/opt/hadoop/data
      - ./java-src:/opt/hadoop/java-src
      - ./jars:/opt/hadoop/jars
      - ./results:/opt/hadoop/results
    networks:
      - hadoop
    depends_on:
      - namenode
      - datanode
      - resourcemanager
      - nodemanager
    stdin_open: true
    tty: true

volumes:
  namenode_data:
  datanode_data:

networks:
  hadoop:
    driver: bridge